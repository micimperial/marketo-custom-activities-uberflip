function loadUser(e){console.log(e.query.vars),userVars=e.query.vars.split("|"),marketo=new Marketo({clientId:userVars[0],clientSecret:userVars[1],endpoint:"https://"+userVars[2]+".mktorest.com/rest",identity:"https://"+userVars[2]+".mktorest.com/identity"}),listId=userVars[3],customActivity=userVars[4]}var express=require("express"),bodyParser=require("body-parser"),url=require("url"),pkg=require("./package"),request=require("request"),moment=require("moment"),Marketo=require("node-marketo-rest"),port=process.env.PORT,app=express(),endpoint,identity,clientId,clientSecret,listId,marketo,customActivity,primaryAttributeValue,userVars;app.use(bodyParser.json()),app.get("/",function(e,r){r.send(pkg.name+" listening on "+port)}),app.all("/get-fields",function(e,r){loadUser(e);var t=[];marketo.lead.describe().then(function(e){var s=e.result;s.forEach(function(e){var r={display_name:e.displayName,html_name:e.rest.name,control_type:"text",required:!1,active:!1,locked:!1};console.dir(r),t.push(r)}),r.json(t),r.status(200),r.end()})},function e(e){e.error&&res.json({errors:[{message:e.error,code:e.code}]})}),app.post("/submit",function(e,r){console.log(e),loadUser(e);var t=e.body.submission.fields;primaryAttributeValue=e.body.submission.fields.primaryAttributeValue,delete t.primaryAttributeValue,t.uf_conversion_item_id=e.body.cta_id||"",t.uf_conversion_item_title=e.body.submission.url||"",marketo.lead.createOrUpdate([t]).then(function(e,r){var t=marketo._connection._tokenData.access_token,s=moment().add(1,"days"),a=e.result[0].id,i={input:[{leadId:e.result[0].id||0,activityDate:s.format("YYYY-MM-DDThh:mm:ssZ"),activityTypeId:customActivity||"",primaryAttributeValue:primaryAttributeValue||""}]};request({url:"https://"+userVars[2]+".mktorest.com/rest/v1/activities/external.json?access_token="+t,method:"POST",json:i},function(e,r,t){e||200!=r.statusCode?console.log(e):(leadJson={list:listId,id:[a],listOperationRequest:{input:[{id:a}]}},marketo.list.addLeadsToList(listId,[a]))})}),r.end()}),app.listen(port,function(){console.log(pkg.name+" listening on port "+port)});
